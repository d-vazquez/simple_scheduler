

#include <stdbool.h>
#include <stdint.h>
#include <stddef.h>
#include "i2c_tiva.h"


#define SSD1306_MEMORYMODE              0x20
#define SSD1306_COLUMNADDR              0x21
#define SSD1306_PAGEADDR                0x22
#define SSD1306_SETCONTRAST             0x81
#define SSD1306_CHARGEPUMP              0x8D
#define SSD1306_SEGREMAP                0xA0
#define SSD1306_DISPLAYALLON_RESUME     0xA4
#define SSD1306_DISPLAYALLON            0xA5
#define SSD1306_NORMALDISPLAY           0xA6
#define SSD1306_INVERTDISPLAY           0xA7
#define SSD1306_SETMULTIPLEX            0xA8
#define SSD1306_DISPLAYOFF              0xAE
#define SSD1306_DISPLAYON               0xAF
#define SSD1306_COMSCANINC              0xC0
#define SSD1306_COMSCANDEC              0xC8
#define SSD1306_SETDISPLAYOFFSET        0xD3
#define SSD1306_SETDISPLAYCLOCKDIV      0xD5
#define SSD1306_SETPRECHARGE            0xD9
#define SSD1306_SETCOMPINS              0xDA
#define SSD1306_SETVCOMDETECT           0xDB
#define SSD1306_SETSTARTLINE            0x40
#define SSD1306_DEACTIVATE_SCROLL       0x2E

#define SCREEN_WIDTH                    128
#define SCREEN_HEIGHT                   32

#define SCREEN_ADDRESS                  0x3C


static void drawPixel(int x,int y, int pixel);


// This will print a border on its own
uint8_t vram[] =
{
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x10, 0x10, 0x10, 0x10, 0xf0, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0xf0, 0x10, 0x10, 0x10, 0x10, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x08, 0x08, 0x08, 0x08, 0x0f, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08,
 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0f, 0x08, 0x08, 0x08, 0x08, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};
uint16_t vram_len = sizeof(vram)/sizeof(vram[0]);

i2c_burst init_seq[] =
{
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_DISPLAYOFF                   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETDISPLAYCLOCKDIV,   0x80   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETMULTIPLEX,         0x1F   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETDISPLAYOFFSET,     0x0    } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETSTARTLINE | 0x0           } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_CHARGEPUMP                   } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {0x14                                 } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_MEMORYMODE,           0x00   } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SEGREMAP | 0x1               } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_COMSCANDEC                   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETCOMPINS,           0x2    } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETCONTRAST,          0x8F   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETPRECHARGE,         0xF1   } },
     { .count = 2, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_SETVCOMDETECT,        0x40   } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_DISPLAYALLON_RESUME          } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_NORMALDISPLAY                } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_DEACTIVATE_SCROLL            } },
     { .count = 1, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_DISPLAYON                    } }
};
uint16_t init_seq_len = sizeof(init_seq)/sizeof(init_seq[0]);

i2c_burst page_setup_seq[] =
{
 { .count = 3, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_PAGEADDR,    0x00,   0xFF    } },
 { .count = 3, .preamble = 0x00, .data_is_ptr = 0, .payload = {SSD1306_COLUMNADDR,  0x00,   0x7F    } }
};
uint16_t page_setup_seq_len = sizeof(page_setup_seq)/sizeof(page_setup_seq[0]);

// Map static VRAM to i2c burst, easilly modify the static VRAM in place
i2c_burst vram_print[] =
{
 { .count = 256, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 256 * 0) },
 { .count = 256, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 256 * 1) },
// { .count = 128, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 128 * 2) },
// { .count = 128, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 128 * 3) },
// { .count = 64, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 64 * 4) },
// { .count = 64, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 64 * 5) },
// { .count = 64, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 64 * 6) },
// { .count = 64, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 64 * 7) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 8) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 9) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 10) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 11) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 12) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 13) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 14) },
// { .count = 32, .preamble = 0x40, .data_is_ptr = 1, .payload_ptr = (vram + 32 * 15) }
};
uint16_t vram_print_len = sizeof(vram_print)/sizeof(vram_print[0]);

void InitScreen(void)
{
    InitI2C0();

    uint8_t indx = 0;
    for (indx = 0; indx < init_seq_len; indx++)
    {
        I2CSend_withPreamble(0x3C, &init_seq[indx]);
    }
}

void PrintScreen(void)
{

    uint8_t indx = 0;
    for (indx = 0; indx < page_setup_seq_len; indx++)
    {
        I2CSend_withPreamble(0x3C, &page_setup_seq[indx]);
    }

    for (indx = 0; indx < vram_print_len; indx++)
    {
        I2CSend_withPreamble(0x3C, &vram_print[indx]);
    }
}

void FillbarScreen(uint8_t percent)
{
    // cap value
    if(percent > 100)
    {
        percent = 100;
    }

    // Bar boundaries
    // x {14...113}
    // y { 5...26 }
    int y, x = 0;
    for(y = 5; y < 27; y++)
    {
        for(x = 14; x < 113; x++)
        {
            int pixel = percent >= (x - 14) ? 1 : 0;    // 1 for draw
            drawPixel(x, y, pixel);
        }
    }
}

static void drawPixel(int x,int y, int pixel)
{
      x = SCREEN_WIDTH - x - 1;
      if(pixel)
      {
          vram[x + (y / 8) * SCREEN_WIDTH] |= (1 << (y & 7));
      }
      else
      {
          vram[x + (y / 8) * SCREEN_WIDTH] &= ~(1 << (y & 7));
      }
}







